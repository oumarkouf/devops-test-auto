@Library('pfPipeline@tags/4') _

def BUILD_SLAVE_IMG = 'devpico-pfc.dev.echonet:8083/bnpp-pf/build-slave:1.7'
def BUILD_PYTHON_IMG = 'devpico-pfc.dev.echonet:8083/bnpp-pf/python:1.6'

def TEST_ROBOT_IMG = 'devpico-pfc.dev.echonet:8083/bnpp-pf/robot-framework:1.0'
def TEST_BROWSER = 'chrome'

pipeline {
	agent {
		label 'docker'
	}

	options {
		// the gitlab connection to use with admpico token 
        gitLabConnection('git-pfc.rb.echonet')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '5'))
        timeout(time: 1, unit: 'HOURS')
		ansiColor('xterm')
	}
	
	triggers {
		// nigthly builds (only on master)
		//cron('0 8 * * 1-5' : '')
		// start build on gitlab push (need good configuration in gitlab for the project)
		gitlab(
			triggerOnPush: true
		)
	}
	

    stages {

			stage('Tests Portlet Administration') {
				agent {
    				docker { 
    						label 'docker'
    						image "${TEST_ROBOT_IMG}"
    						args "-e BROWSER=${TEST_BROWSER}"
							reuseNode true
    					}
			    }

				steps {
					sh "run-tests.sh ${WORKSPACE}/reportAdmin ${WORKSPACE}/administration || true"
					robot otherFiles: '*.png', outputPath: "${WORKSPACE}/reportAdmin",passThreshold : 100, unstableThreshold: 95.0
				}

			}

    }

	post {

		always {
			pfSendNotification(alwaysSend : true, to : 'oumar.kouferidji@externe.bnpparibas.com');
		}
	}
}